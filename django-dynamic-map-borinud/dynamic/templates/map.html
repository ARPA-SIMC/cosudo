{% load static %}
<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="{% static "dynamic/images/rmap.ico" %}"/>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
          integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
          integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
          crossorigin=""/>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.0-alpha14/css/tempusdominus-bootstrap-4.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
          integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
          crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css"/>
    <script
            src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
            crossorigin="anonymous"></script>
    <title>Dynamic</title>
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html, body, #map {
            height: 100%;
            width: 100%;
        }

        .prunecluster {
            font-size: 12px;
            border-radius: 20px;
            transition: all 0.3s linear;
        }

        .leaflet-marker-icon.prunecluster-anim,
        .leaflet-marker-shadow.prunecluster-anim,
        .leaflet-markercluster-icon.prunecluster-anim {
            transition: all 0.3s linear;
        }

        .leaflet-zoom-anim .leaflet-zoom-animated.leaflet-marker-icon,
        .leaflet-zoom-anim .leaflet-zoom-animated.leaflet-marker-shadow,
        .leaflet-zoom-anim .leaflet-zoom-animated.leaflet-markercluster-icon {
            transition: transform 0.25s cubic-bezier(0, 0, 0.25, 1);
        }

        .prunecluster div {
            width: 30px;
            height: 30px;
            text-align: center;
            margin-left: 5px;
            margin-top: 5px;
            border-radius: 50%;
        }

        .prunecluster div span {
            line-height: 30px;
        }

        .prunecluster-small {
            background-color: #b5e28c;
            background-color: rgba(181, 226, 140, 0.6);
        }

        .prunecluster-small div {
            width: 28px;
            height: 28px;
            background-color: #6ecc39;
            background-color: rgba(110, 204, 57, 0.6);
        }

        .prunecluster-small div span {
            line-height: 28px;
        }

        .prunecluster-medium {
            background-color: #f1d357;
            background-color: rgba(241, 211, 87, 0.6);
        }

        .prunecluster-medium div {
            background-color: #f0c20c;
            background-color: rgba(240, 194, 12, 0.6);
        }

        .prunecluster-large {
            background-color: #fd9c73;
            background-color: rgba(253, 156, 115, 0.6);
        }

        .prunecluster-large div {
            width: 34px;
            height: 34px;
            background-color: #f18017;
            background-color: rgba(241, 128, 23, 0.6);
        }

        .prunecluster-large div span {
            line-height: 34px;
        }

        .myDivIcon {
            /*opacity: .9; */
            border: 1px solid #000;
            font-family: "Lucida Grande", "Arial", sans-serif;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            width: 20px;
            height: 14px;
            vertical-align: middle;
            border-radius: 3px;
            -moz-border-radius: 3px;
            -webkit-border-radius: 3px;
            -khtml-border-radius: 3px;
            color: #FFF;
            background: #333;
            line-height: 14px;
        }

        #overlay {
            position: fixed;
            top: 0;
            z-index: 10000000000;
            width: 100%;
            height: 100%;
            display: block;
            background: rgba(0, 0, 0, 0.6);
        }

        .cv-spinner {
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px #ddd solid;
            border-top: 4px #2e93e6 solid;
            border-radius: 50%;
            animation: sp-anime 0.8s infinite linear;
        }

        #sidebar {
            z-index: 1000;
            width: 264px;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .legend {
            line-height: 18px;
            color: #555;
        }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }

        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        @keyframes sp-anime {
            100% {
                transform: rotate(360deg);
            }
        }

    </style>
    <script>
        $(window).on('load', function () {
            // Animate loader off screen
            $("#overlay").fadeOut("slow");
        });
    </script>
</head>
<body>

<div id="overlay" style="z-index: 100000;">
    <div class="cv-spinner">
        <span class="spinner"></span>
    </div>
</div>

<div id="sidebar" class="position-absolute bg-white">
    <!-- SEARCH BAR -->
    <div class="pt-3 px-4">
        <div class="form-group">
            <label for="ident">Ident</label>
            <select id="ident" class="form-control" name="ident" onchange="populateForm(this)">
                <option value="*">*</option>
            </select>
        </div>


        <div class="form-group">
            <label for="lon_lat" style="width: 100%">Lon lat</label>
            <select id="lon_lat" class="form-control" name="lon_lat" onchange="populateForm(this)">
                <option value="*">*</option>
            </select>
        </div>


        <div class="form-group">
            <label for="network" style="width: 100%">Network</label>
            <select id="network" class="form-control" name="network" onchange="populateForm(this)">
                <option value="*">*</option>
            </select>
        </div>

        <div hidden>
            <div class="form-group">
                <label for="date" style="width: 100%">Date</label>
                <select class="form-control" id="date" name="date" onchange="populateForm(this)">
                    <option value="*">*</option>
                </select>
            </div>
        </div>


        <div class="form-group select-date">
            <label for="datetimepicker">Date</label>
            <div class="input-group date" id="datetimepicker" data-target-input="nearest">
                <input type="text"
                       class="form-control datetimepicker-input col-xs-10"
                       data-target="#datetimepicker"/>
                <div class="input-group-append col-xs-2"
                     data-target="#datetimepicker" data-toggle="datetimepicker">
                    <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="hour">Hour</label>
            <select class="form-control" id="hour" name="hour" onchange="populateHour(this)">
                <option value="*">*</option>
                <option value="00">00</option>
                <option value="01">01</option>
                <option value="02">02</option>
                <option value="03">03</option>
                <option value="04">04</option>
                <option value="05">05</option>
                <option value="06">06</option>
                <option value="07">07</option>
                <option value="08">08</option>
                <option value="09">09</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
                <option value="17">17</option>
                <option value="18">18</option>
                <option value="19">19</option>
                <option value="20">20</option>
                <option value="21">21</option>
                <option value="22">22</option>
                <option value="23">23</option>
            </select>
        </div>


        <div class="form-group">
            <label for="vars" style="width: 100%">Vars</label>
            <select class="form-control" id="vars" name="vars" onchange="populateForm(this)">
                <option value="*">*</option>
            </select>
        </div>


        <div class="form-group">
            <label for="timerange" style="width: 100%">Timerange</label>
            <select class="form-control" id="timerange" name="timerange" onchange="populateForm(this)">
                <option value="*">*</option>
            </select>
        </div>


        <div class="form-group">
            <label for="level" style="width: 100%">Level</label>
            <select class="form-control" id="level" name="level" onchange="populateForm(this)">
                <option value="*">*</option>
            </select>
        </div>


        <div class="form-group">
            <label for="dsn" style="width: 100%">DNS</label>
            <select class="form-control" id="dsn" name="dsn" onchange="populateDSN(this)">
                <option value="report">report</option>
                <option value="sample">sample</option>
            </select>
        </div>


        <div class="row">
            <div class="col-12 text-center">
                <!-- hide input used to copyurl to save query-->
                <input id="newUrlClipboard" name="newUrlClipboard" type="text" style="display:none"/>
                <button class="btn btn-outline-primary btn-block" onclick="copyUrl();">
                    <div class="d-flex flex-row justify-content-between"><i class="fa fa-copy"></i> Copy url</div>
                </button>
                <button class="btn btn-outline-primary btn-block" disabled id="showGraphButton"
                        onclick="showAllGraph();">
                    <div class="d-flex flex-row justify-content-between"><i class="fa fa-line-chart"></i>
                        Show graph
                    </div>
                </button>
                <button class="btn btn-outline-success btn-block" id="searchButton" onclick="updateMap();">
                    <div class="d-flex flex-row justify-content-between"><i class="fa fa-search"></i> SEARCH</div>
                </button>


            </div>

        </div>
    </div>

</div>
<div id="map"></div>
<div class="modal" id="modalGraph" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document" style="max-width: 900px;">
        <div class="modal-content">
            <div class="modal-body">
                <div id="chartHeader"></div>
                <div id="loadingChart" class="loader"></div>
                <div id="chart-container">
                    <canvas id="chart"></canvas>
                </div>
            </div>
            <div class="modal-footer">
                <a disabled download="chart.png" id="printGraph" role="button" class="btn btn-primary">Download
                    grafico</a>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://use.fontawesome.com/b1eabdd73a.js"></script>

<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
        integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
        crossorigin="anonymous"></script>
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.27.0/moment-with-locales.min.js"></script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.0-alpha14/js/tempusdominus-bootstrap-4.min.js"></script>
<script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/prunecluster@2.1.0/dist/PruneCluster.js"></script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@0.7.7"></script>
<script>

    (function (L) {
        /*
        * by tonekk. 2014, MIT License
        */

        L.ExtendedDivIcon = L.DivIcon.extend({
            createIcon: function (oldIcon) {
                let div = L.DivIcon.prototype.createIcon.call(this, oldIcon);

                if (this.options.id) {
                    div.id = this.options.id;
                }

                if (this.options.style) {
                    for (var key in this.options.style) {
                        div.style[key] = this.options.style[key];
                    }
                }
                return div;
            }
        });

        L.extendedDivIcon = function (options) {
            return new L.ExtendedDivIcon(options);
        }
    })(window.L);

    /**
     * Handle the select system of the search form,
     * every time that a select change,
     * set in other select new possible values.
     */
    function populateForm(e) {
        for (let id of id_select_list) {
            if (e && e.id === id) {
                selected_values[id] = document.getElementById(id).selectedOptions[0].value;
            } else {
                let index_list = [...Array(select_values_lists[id].length).keys()];
                for (let id2 of id_select_list) {
                    if (id !== id2) {
                        let target = document.getElementById(id2).selectedOptions[0].value;
                        if (target !== "*") {
                            let temp_index_list = [];
                            for (let i of index_list) {
                                if (select_values_lists[id2][i] === target) {
                                    temp_index_list.push(i);
                                }
                            }
                            index_list = temp_index_list;
                        }
                    }
                }
                let values = [];
                for (let i of index_list) {
                    values.push(select_values_lists[id][i]);
                }
                populateSelect(id, values);
            }
        }

        // update only calendar filed
        populateDate();
        //select hour and dsn
        let select = document.getElementById("hour");
        select.value = selected_values["hour"];
        select = document.getElementById("dsn");
        select.value = selected_values["dsn"];
    }

    /**
     * Equal to populateForm but only used for hour, hour not impact on other var
     */
    function populateHour(e) {
        if (e && e.id === "hour") {
            selected_values["hour"] = document.getElementById("hour").selectedOptions[0].value;
        }
    }

    /**
     * populate calendar field and on change use hide filed  data  to get possible value
     */
    function populateDate() {

        let select = document.getElementById("date");
        let options = [];
        for (let i = 0, len = select.options.length; i < len; i++) {
            if (select.options[i].value !== "*") {
                options.push(select.options[i].value);
            }
        }
        $('#datetimepicker').datetimepicker({
            format: 'L',
            defaultDate: moment(selected_values.date, "YYYY/MM/DD"), //selected_values.date,
            enabledDates: options,
            locale: 'it'
        });

        $('#datetimepicker').on('change.datetimepicker datetimepicker.change', function (e) {
            // set on hidden field the selected date  and call function that update all filed using onchenge vent
            let selected_date = e.date.toDate();
            selected_date = selected_date.getFullYear() + "-" +
                ((selected_date.getMonth() + 1 < 10) ? '0' + (selected_date.getMonth() + 1) : '' + (selected_date.getMonth() + 1)) + "-" +
                ((selected_date.getDate() < 10) ? '0' + (selected_date.getDate()) : '' + (selected_date.getDate()))
            let select = document.getElementById("date");
            let opt = document.createElement('option');
            opt.value = selected_date;
            opt.innerHTML = selected_date;
            opt.selected = true;
            select.appendChild(opt);

            select.dispatchEvent(new Event('change'));
        });

    }

    /**
     * Equal to populateForm but only used for dsn, dsn not impact on other var
     */
    function populateDSN(e) {
        if (e && e.id === "dsn") {
            selected_values["dsn"] = document.getElementById("dsn").selectedOptions[0].value;
        }
    }


    /**
     *
     * @param id select id
     * @param values options to add to the select
     * Add to the select distinct value and select again the option selected
     * selected_values is a global variable!
     */
    function populateSelect(id, values) {
        //do a distinct operation
        let unique = [...new Set(values)];
        var select = document.getElementById(id);
        //clear select option
        for (i = select.options.length - 1; i >= 0; i--) {
            select.options[i] = null;
        }
        //create  wildcard option
        let opt = document.createElement('option');
        opt.value = "*";
        opt.innerHTML = "*";
        if (selected_values[id] === "*") {
            opt.selected = true;
        }
        select.appendChild(opt);

        //append distinct option to select
        for (var i = 0; i < unique.length; i++) {
            let opt = document.createElement('option');
            opt.value = unique[i];
            let unique_html = unique[i];
            //Use borinud config file to translate code in verbose text
            if (id === "vars") {
                if (borinud.config.B[unique_html] !== undefined) {
                    unique_html = borinud.config.B[unique_html].description + " " + borinud.config.B[unique_html].unit;
                }
            } else if (id === "level") {
                let [l1, l2, l3, l4] = borinud.config.level.decode(unique_html);
                unique_html = borinud.config.level.describe(l1, l2, l3, l4);
            } else if (id === "timerange") {
                let [t1, t2, t3, t4] = borinud.config.trange.decode(unique_html);
                unique_html = borinud.config.trange.describe(t1, t2, t3, t4);
            }
            opt.innerHTML = unique_html;


            if (selected_values[id] === unique[i]) {
                opt.selected = true;
            }
            select.appendChild(opt);
        }

    }

    /**
     * Copy to clipboard the new url to repeat query with same params
     */
    function copyUrl() {
        //create the new url
        let newUrl = `${url_vars[0]}//${url_vars[2]}/${url_vars[3]}/${selected_values.ident}/${selected_values.lon_lat}/` +
            `${selected_values.network}/${selected_values.timerange}/${selected_values.level}/${selected_values.vars}/` +
            `${url_vars[10]}/${selected_values.date.split("-")[0]}/${selected_values.date.split("-")[1]}/${selected_values.date.split("-")[2]}` +
            `${selected_values.hour !== "*" ? "/" + selected_values.hour : ""}?dsn=${selected_values.dsn}`;
        /* Get the text field */
        let copyText = document.getElementById("newUrlClipboard");
        copyText.style.display = 'block';
        copyText.value = newUrl;

        /* Select the text field */
        copyText.select();

        /* Copy the text inside the text field */
        document.execCommand("copy");
        copyText.style.display = 'none';
        alert("New url copy to clipboard.")
    }

    function getColorIndex(d, min, max) {
        var delta = (max - min) / (colors.length);
        return Math.max(0, Math.min(colors.length - 1, Math.floor((d - min) / delta)));
    }


    function getColor(d, min, max) {
        return colors[getColorIndex(d, min, max)];
    }


    function null2_(i) {
        return (i === null) ? "-" : i;
    }

    function getRandomColor() {
        var letters = '0123456789ABCDEF';
        var color = '#';
        for (var i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    function setpopup(feature) {
        let b = borinud.config.B[feature.properties.var];

        let popupText = "<div>" +
            "Ident: " + null2_(feature.properties.ident) +
            "<br>Lon: " + feature.properties.lon / 100000 +
            "<br>Lat: " + feature.properties.lat / 100000 +
            "<br>Network: " +  feature.properties.network +
            "<br>Trange: " + borinud.config.trange.describe(feature.properties.trange[0], feature.properties.trange[1], feature.properties.trange[2]) +
            "<br>Level: " + borinud.config.level.describe(feature.properties.level[0], feature.properties.level[1], feature.properties.level[2], feature.properties.level[3]) +
            "<br>Date: " + feature.properties.date +
            "<br>Var: " + b.description + " " + feature.properties.val + " (" + b.unit + ")";


        if (selected_values.dsn === 'sample' || selected_values.dsn === 'report') {
            let {datefrom, dateuntil} = selectedDateFormat()
            var urlGraph = `{{url_borinud}}/geojson/${null2_(feature.properties.ident)}/${feature.properties.lon + "," + feature.properties.lat}/` +
                `${null2_(feature.properties.network)}/${feature.properties.trange[0] +
                "," + feature.properties.trange[1] + "," + feature.properties.trange[2]}/${null2_(feature.properties.level[0]) + "," + null2_(feature.properties.level[1]) + "," +
                null2_(feature.properties.level[2]) + "," + null2_(feature.properties.level[3])}/${feature.properties.var}/` +
                `timeseries/${selected_values.date.split("-")[0]}/${selected_values.date.split("-")[1]}/${selected_values.date.split("-")[2]}` +
                `${selected_values.hour !== "*" ? "/" + selected_values.hour : ""}?dsn=${selected_values.dsn}`

            let headerModal = "Ident: " + null2_(feature.properties.ident) + "Coords: " + feature.properties.lat + "," + feature.properties.lon +
                " Network:" + null2_(feature.properties.network)
                + "<br>" + borinud.config.trange.describe(feature.properties.trange[0], feature.properties.trange[1], feature.properties.trange[2]) + "<br>"
                + borinud.config.level.describe(feature.properties.level[0], feature.properties.level[1], feature.properties.level[2], feature.properties.level[3]) + "<br>" + datefrom + " - " + dateuntil + "GMT"

            popupText += '<br><button onclick="showGraph(\'' + urlGraph + '\',\'' + headerModal + '\')" type="button" class="btn btn-primary open-graph" >Show graph</button>';

            /*

            if (feature.properties.ident !== null) {
                popupText += "<br><a href='/showdata/" + null2_(feature.properties.ident) + "/" + feature.properties.lon + "," +
                    feature.properties.lat + "/" + null2_(feature.properties.network) + "/" + feature.properties.trange + "/" +
                    null2_(feature.properties.level[0]) + "," + null2_(feature.properties.level[1]) + "," +
                    null2_(feature.properties.level[2]) + "," + null2_(feature.properties.level[3]) + "/" +
                    null2_(feature.properties.var) +
                    `/timeseries/${selected_values.date.split("-")[0]}/${selected_values.date.split("-")[1]}/${selected_values.date.split("-")[2]}` +
                    `${selected_values.hour !== "*" ? "/" + selected_values.hour : ""}?dsn=${selected_values.dsn}_mobile'>` +
                    "Graph for mobile station</a>";
            }*/
        } /*else {
            popupText += "<br><a href='/showdata/" + null2_(feature.properties.ident) + "/" + feature.properties.lon +
                "," + feature.properties.lat + "/" + null2_(feature.properties.network) + "/" + feature.properties.trange +
                "/" + null2_(feature.properties.level[0]) + "," + null2_(feature.properties.level[1]) + "," +
                null2_(feature.properties.level[2]) + "," + null2_(feature.properties.level[3]) + "/" +
                null2_(feature.properties.var) +
                `/timeseries/${selected_values.date.split("-")[0]}/${selected_values.date.split("-")[1]}/${selected_values.date.split("-")[2]}` +
                `${selected_values.hour !== "*" ? "/" + selected_values.hour : ""}?dsn=${selected_values.dsn}'>` +
                "Graph data for station" +
                "</a>";
        }*/
        popupText += "</div>";
        return popupText;
    }

    function selectedDateFormat() {
        let dateFrom;
        let dateUntil;
        if (selected_values.hour === "*") {
            dateFrom = "00:00_" + selected_values.date.replace(/-/g, "")
            dateUntil = "23:59_" + selected_values.date.replace(/-/g, "")
        } else {
            dateFrom = (parseInt(selected_values.hour) - 1).toString().padStart(2, '0') + ":30_" + selected_values.date.replace(/-/g, "")
            dateUntil = selected_values.hour.padStart(2, '0') + ":30_" + selected_values.date.replace(/-/g, "")
        }
        return {dateFrom, dateUntil};
    }

    function showGraph(url, headerText) {
        $.ajax({
            url: url,
            dataType: "json",
            success: function (collection) {
                let data_dict = {}
                collection.features.forEach((feature) => {
                    let key = feature.properties.lat.toString() + "," + feature.properties.lon.toString() + "," + feature.properties.trange[0].toString()
                    if (!(key in data_dict))
                        data_dict[key] = []
                    data_dict[key].push({"x": new Date(feature.properties.date), "y": feature.properties.val})
                })
                let datasets = []
                for (let key in data_dict)
                    datasets.push({data: data_dict[key], fill: false, borderColor: getRandomColor()})
                // get the canvas element
                document.querySelector("#chart-container").innerHTML = '<canvas id="chart"></canvas>';
                var ctx = document.getElementById('chart').getContext('2d');
                $("#modalGraph").modal("show");
                let chart = new Chart(ctx, {
                    legend: {
                        display: false
                    },
                    // The type of chart we want to create
                    type: 'line',
                    // The data for our dataset
                    data: {
                        datasets: datasets,
                    },
                    options: {
                        scales: {
                            xAxes: [{
                                type: "time",
                                time: {
                                    parser: "D/M/YYYY, H:mm:ss",
                                    displayFormats: {
                                        millisecond: 'DD/MM/YYYY HH:mm:ss',
                                        second: 'DD/MM/YYYY HH:mm:ss',
                                        minute: 'DD/MM/YYYY HH:mm:ss',
                                        hour: 'DD/MM/YYYY HH:mm:ss',
                                        day: 'DD/MM/YYYY HH:mm:ss',
                                        week: 'DD/MM/YYYY HH:mm:ss',
                                        month: 'DD/MM/YYYY HH:mm:ss',
                                        quarter: 'DD/MM/YYYY HH:mm:ss',
                                        year: 'DD/MM/YYYY HH:mm:ss'
                                    },
                                    tooltipFormat: 'DD/MM/YYYY HH:mm:ss'
                                }
                            }],
                        },

                        animation: {
                            onComplete: function (e) {
                                this.options.animation.onComplete = null;
                                // remove loading spinner
                                jQuery("#loadingChart").hide();
                                // create image from canvas
                                let url = chart.toBase64Image();
                                // set download link to button
                                let button = document.getElementById("printGraph");
                                button.href = url;
                                // enable button download
                                button.removeAttribute("disabled");

                            }
                        },
                        plugins: {
                            zoom: {
                                // Container for pan options
                                pan: {
                                    // Boolean to enable panning
                                    enabled: true,

                                    // Panning directions. Remove the appropriate direction to disable
                                    // Eg. 'y' would only allow panning in the y direction
                                    mode: 'xy'
                                },

                                // Container for zoom options
                                zoom: {
                                    // Boolean to enable zooming
                                    enabled: true,

                                    // Zooming directions. Remove the appropriate direction to disable
                                    // Eg. 'y' would only allow zooming in the y direction
                                    mode: 'xy',
                                }
                            }
                        }
                    }
                });
                $("#chartHeader").html(headerText)
            },
            beforeSend: function () {
                $("#overlay").fadeIn(300);
            },
            complete: function () {
                $("#overlay").fadeOut(300);
            },
        });
    }

    function showAllGraph() {
        let headerModal = ""
        let url = `{{url_borinud}}/geojson/${selected_values.ident}/${selected_values.lon_lat}/` +
            `${selected_values.network}/${selected_values.timerange}/${selected_values.level}/${selected_values.vars}/` +
            `timeseries/${selected_values.date.split("-")[0]}/${selected_values.date.split("-")[1]}/${selected_values.date.split("-")[2]}` +
            `${selected_values.hour !== "*" ? "/" + selected_values.hour : ""}?dsn=${selected_values.dsn}`;
        showGraph(url, headerModal)
    }

    //update map markers
    function updateMap() {
        $("#showGraphButton").attr("disabled", true)
        //clear map  and  reset values
        map.eachLayer(function (layer) {
            map.removeLayer(layer);
        });
        // legend.remove();
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        coords = [];
        min = Infinity;
        max = -Infinity;

        //create request url
        var url = `{{url_borinud}}/geojson/${selected_values.ident}/${selected_values.lon_lat}/` +
            `${selected_values.network}/${selected_values.timerange}/${selected_values.level}/${selected_values.vars}/` +
            `spatialseries/${selected_values.date.split("-")[0]}/${selected_values.date.split("-")[1]}/${selected_values.date.split("-")[2]}` +
            `${selected_values.hour !== "*" ? "/" + selected_values.hour : ""}?dsn=${selected_values.dsn}`;

        //require map point
        $.ajax({
                url: url,
                dataType: "json",
                success: function (collection) {
                    if (collection.features.length <= 0) {
                        toastr.warning('Nessun risultato!')
                    } else {
                        if (selected_values.vars !== "*") {
                            bcode = borinud.config.B[selected_values.vars];
                        } else {
                            $("#showGraphButton").attr("disabled", false)

                            bcode = {
                                "bcode": "B00001",
                                "description": "Undefined",
                                "unit": "Undefined",
                                "offset": 0,
                                "scale": 1,
                                "userunit": ""
                            }
                        }
                        if (!bcode.scale)
                            bcode.scale = 1
                        if (!bcode.offset)
                            bcode.offset = 0
                        for (let i = 0; i < collection['features'].length; i++) {
                            min = Math.min(min, collection['features'][i].properties.val);
                            max = Math.max(max, collection['features'][i].properties.val);
                        }
                        //  Legend
                        legend.onAdd = function (map) {
                            let div = L.DomUtil.create('div', 'info legend');
                            // loop through our density intervals and generate a label with a colored square for each interval
                            let halfdelta = ((max - min) / (colors.length * 2.));

                            for (let i = 0; i < colors.length; i++) {
                                let grade = min + halfdelta * (i * 2 + 1);
                                div.innerHTML +=
                                    '<div style="background:white">' +
                                    '<b style="background:' + getColor(grade, min, max) + '">&nbsp;&nbsp;&nbsp;</b>&nbsp;' +
                                    (grade * bcode.scale + bcode.offset).toPrecision(5).replace(/\.?0+$/, "") +
                                    '<br>' +
                                    '</div>';
                            }
                            return div;
                        };

                        legend.addTo(map);

                        let pi2 = Math.PI * 2;
                        L.Icon.MarkerCluster = L.Icon.extend({
                            options: {
                                iconSize: new L.Point(44, 44),
                                className: 'prunecluster leaflet-markercluster-icon'
                            },

                            createIcon: function () {
                                let e = document.createElement('canvas');
                                this._setIconStyles(e, 'icon');
                                let s = this.options.iconSize;
                                e.width = s.x;
                                e.height = s.y;
                                this.draw(e.getContext('2d'), s.x, s.y);
                                return e;
                            },

                            createShadow: function () {
                                return null;
                            },

                            draw: function (canvas, width, height) {
                                let start = 0;
                                let prevalent = 0;
                                let prevalentindex = 0;
                                for (let i = 0, l = colors.length; i < l; ++i) {
                                    var size = this.stats[i] / this.population;
                                    if (size > 0) {
                                        if (this.stats[i] > prevalent) {
                                            prevalentindex = i;
                                            prevalent = this.stats[i];
                                        }
                                        canvas.beginPath();
                                        canvas.moveTo(22, 22);
                                        canvas.fillStyle = colors[i];
                                        let from = start;
                                        let to = start + size * pi2;
                                        if (to < from) {
                                            from = start;
                                        }
                                        canvas.arc(22, 22, 22, from, to);
                                        start = to;
                                        canvas.lineTo(22, 22);
                                        //canvas.stroke();
                                        canvas.fill();
                                        canvas.closePath();
                                    }
                                }
                                canvas.beginPath();
                                canvas.fillStyle = "#fff";
                                canvas.arc(22, 22, 15, 0, Math.PI * 2);
                                canvas.stroke();
                                canvas.fill();
                                canvas.closePath();
                                canvas.fillStyle = '#111';
                                canvas.textAlign = 'center';
                                canvas.textBaseline = 'middle';
                                canvas.font = 'bold 10px sans-serif';
                                //canvas.fillText(this.population, 22, 22,28);
                                let halfdelta = ((max - min) / (colors.length * 2.));
                                let grade = min + halfdelta * (prevalentindex * 2 + 1);
                                grade = (grade * bcode.scale + bcode.offset).toPrecision(5).replace(/\.?0+$/, "");
                                canvas.fillText(grade, 22, 22, 28);
                            }
                        });

                        var pruneCluster = new PruneClusterForLeaflet();
                        pruneCluster.Cluster.Size = 15;

                        pruneCluster.BuildLeafletClusterIcon = function (cluster) {
                            let e = new L.Icon.MarkerCluster();
                            e.stats = cluster.stats;
                            e.population = cluster.population;

                            //this try to make the little values more visible (no less of 5%)
                            for (let i = 0, l = e.stats.length; i < l; ++i) {
                                if ((e.stats[i] > 0) && ((e.stats[i] / e.population) < 0.1)) {
                                    let inc = (e.population * 0.05) - e.stats[i];
                                    e.stats[i] += inc;
                                    e.population += inc;
                                }
                            }

                            return e;
                        };

                        pruneCluster.PrepareLeafletMarker = function (leafletMarker, data) {
                            if (leafletMarker.getPopup()) {
                                leafletMarker.setPopupContent(setpopup(data.feature));
                            } else {
                                leafletMarker.bindPopup(setpopup(data.feature));
                            }
                            let val = (data.feature.properties.val * bcode.scale + bcode.offset).toPrecision(5).replace(/\.?0+$/, "");
                            let vallen = val.length * 6 + 6;
                            leafletMarker.setIcon(
                                L.extendedDivIcon({
                                    iconSize: new L.Point(vallen, 14),
                                    labelAnchor: [vallen / 2, 0],
                                    html: val,
                                    className: 'myDivIcon',
                                    style: {backgroundColor: getColor(data.feature.properties.val, min, max)}
                                })
                            );
                            leafletMarker.bindTooltip(data.feature.properties.date.toString());
                        };

                        $.each(collection.features, function (i, feature) {

                            coords.push([feature.geometry.coordinates[1], feature.geometry.coordinates[0]]);

                            let marker = new PruneCluster.Marker(feature.geometry.coordinates[1], feature.geometry.coordinates[0]);
                            marker.data.feature = feature;
                            marker.category = getColorIndex(feature.properties.val, min, max);

                            pruneCluster.RegisterMarker(marker);
                        });

                        map.addLayer(pruneCluster);

                        try {
                            map.fitBounds(coords);
                        } catch (err) {
                            toastr.error("Error setting bounds...");
                        }

                    }

                },
                beforeSend: function () {
                    $("#overlay").fadeIn(300);
                },
                complete: function () {
                    $("#overlay").fadeOut(300);
                },

            }
        )
    }

    Chart.plugins.register({
        beforeDraw: function (c) {
            var ctx = c.chart.ctx;
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, c.chart.width, c.chart.height);
        }
    });
    Chart.defaults.global.legend.display = false;

    // leaflet color utility
    var colors = ['#8501af', '#3e01a3', '#2147fe', '#3192ce', '#65b032', '#cfea2d', '#fdfd47', '#f9bc00', '#f79904', '#f55306', '#f52613', '#a8184b'];
    // global config for borinud request
    var borinud = {
        config: {
            root_el: null,
            ajax: {
                baseUrl: "{{url_borinud}}/jsonline",
                dataType: "text"
            },
        }
    };
    // list of identifiers for select, selected_values and corresponding summaries
    var id_select_list = ["ident", "lon_lat", "network", "date", "vars", "timerange", "level"];
    // list of possibible value for each summaries,
    var select_values_lists = {
        ident: [],
        lon_lat: [],
        network: [],
        date: [],
        hour: ["*", "00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15",
            "16", "17", "18", "19", "20", "21", "22", "23"],
        vars: [],
        timerange: [],
        level: [],
        dsn: ["report", "sample"]
    };
    var today = new Date()

    var selected_values = {
        ident: "*",
        lon_lat: "*",
        network: "*",
        date: today.getFullYear() + "-" +
            ((today.getMonth() + 1 < 10) ? '0' + (today.getMonth() + 1) : '' + (today.getMonth() + 1)) + "-" +
            ((today.getDate() < 10) ? '0' + (today.getDate()) : '' + (today.getDate())),
        hour: "*",
        vars: "*",
        timerange: "*",
        level: "*",
        dsn: "report"
    };

    /**
     * required combination of all summaries and put these in select_values_lists
     *
     */
    $.ajax({
        url: borinud.config.ajax.baseUrl + "/*/*/*/*/*/*/summaries",
        dataType: borinud.config.ajax.dataType,
        success: function (resp) {
            resp = (JSON.parse("{\"j\":[" + resp.replace(/}\n{/g, "}, {") + "]}")).j;

            for (var r of resp) {
                select_values_lists.ident.push(r.ident + "");
                select_values_lists.lon_lat.push(r.lon + "," + r.lat);
                select_values_lists.network.push(r.network + "");
                select_values_lists.date.push((r.date[0] + "").substring(0, 10));
                let d = r.data[0];
                select_values_lists.vars.push(Object.keys(d.vars)[0] + "");
                select_values_lists.timerange.push(d.timerange + "");
                let level = d.level.map((level) => {
                    if (level == null) {
                        return "-"
                    }
                    return level
                })
                select_values_lists.level.push(level + "");
            }
            populateForm(undefined);
        },

        error: function (e) {
            toastr.error("Borinud not available!")
            $("#searchButton").attr("disabled", true)
            console.log(e.toString());
        }
    });
    var map = L.map('map', {zoomControl: false}).setView([43, 11], 13);
    L.control.zoom({
        position: 'topright'
    }).addTo(map);
    var coords = [];
    var legend = L.control({position: 'bottomright'});
    var min = Infinity;
    var max = -Infinity;
    var bcode = {
        "bcode": "B00001",
        "description": "Undefined",
        "unit": "Undefined",
        "offset": 0,
        "scale": 1,
        "userunit": ""
    }


    $("#sidebar").resizable({
        handles: 'e', stop: function (e, ui) {
            widthMenu = document.getElementById('sidebar').offsetWidth;
        }
    });

    updateMap();

</script>
<script type="text/javascript" src="{% static 'dynamic/js/borinud.trange.js' %}"></script>
<script type="text/javascript" src="{% static 'dynamic/js/borinud.level.js' %}"></script>
<script type="text/javascript" src="{% static 'dynamic/js/borinud.B.js' %}"></script>
</body>
</html>