<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
          integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
          integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
          crossorigin=""/>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.0-alpha14/css/tempusdominus-bootstrap-4.min.css"/>

    <title>Hello, world!</title>
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html, body, #map {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
 <div style="width: 100%">
        <!-- SEARCH BAR -->
        <div class="row">
            <div class="col-sm-6 col-md-4 col-lg-3">
                <label for="ident" style="width: 100%">Ident</label>
                <select id="ident" name="ident" onchange="populateForm(this)">
                    <option value="*">*</option>
                </select>
            </div>

            <div class="col-sm-6 col-md-4 col-lg-3">
                <label for="lon_lat" style="width: 100%">Lon lat</label>
                <select id="lon_lat" name="lon_lat" onchange="populateForm(this)">
                    <option value="*">*</option>
                </select>
            </div>

            <div class="col-sm-6 col-md-4 col-lg-3">
                <label for="network" style="width: 100%">Network</label>
                <select id="network" name="network" onchange="populateForm(this)">
                    <option value="*">*</option>
                </select>
            </div>

            <div hidden>
                <label for="date" style="width: 100%">Date</label>
                <select id="date" name="date" onchange="populateForm(this)">
                    <option value="*">*</option>
                </select>
            </div>

            <div class="container col-sm-6 col-md-4 col-lg-3">
                <div class="row select-date">
                    <div class="col-xs-8">
                        <label for="datetimepicker" style="width: 100%">Date</label>
                        <div class="input-group date" id="datetimepicker" data-target-input="nearest">
                            <div class="row">
                                <input type="text" style="width: 80%"
                                       class="form-control datetimepicker-input col-xs-10"
                                       data-target="#datetimepicker"/>
                                <div class="input-group-append col-xs-2" style="width: 20%"
                                     data-target="#datetimepicker" data-toggle="datetimepicker">
                                    <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-4" style="padding-right: 0;">
                        <label for="hour" style="width: 100%">Hour</label>
                        <select id="hour" name="hour" onchange="populateHour(this)">
                            <option value="*">*</option>
                            <option value="00">00</option>
                            <option value="01">01</option>
                            <option value="02">02</option>
                            <option value="03">03</option>
                            <option value="04">04</option>
                            <option value="05">05</option>
                            <option value="06">06</option>
                            <option value="07">07</option>
                            <option value="08">08</option>
                            <option value="09">09</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                            <option value="17">17</option>
                            <option value="18">18</option>
                            <option value="19">19</option>
                            <option value="20">20</option>
                            <option value="21">21</option>
                            <option value="22">22</option>
                            <option value="23">23</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="col-sm-6 col-md-4 col-lg-3">
                <label for="vars" style="width: 100%">Vars</label>
                <select id="vars" name="vars" onchange="populateForm(this)">
                    <option value="*">*</option>
                </select>
            </div>

            <div class="col-sm-6 col-md-4 col-lg-3">
                <label for="timerange" style="width: 100%">Timerange</label>
                <select id="timerange" name="timerange" onchange="populateForm(this)">
                    <option value="*">*</option>
                </select>
            </div>


            <div class="col-sm-6 col-md-4 col-lg-3">
                <label for="level" style="width: 100%">Level</label>
                <select id="level" name="level" onchange="populateForm(this)">
                    <option value="*">*</option>
                </select>
            </div>

            <div class="col-sm-6 col-md-4 col-lg-3">
                <label for="dsn" style="width: 100%">DNS</label>
                <select id="dsn" name="dsn" onchange="populateDSN(this)">
                    <option value="report">report</option>
                    <option value="sample">sample</option>
                </select>
            </div>

            <div class="col-sm-6 col-md-4 col-lg-3">
                <br>
                <!-- hide input used to copyurl to save query-->
                <input id="newUrlClipboard" name="newUrlClipboard" type="text" style="display:none"/>
                <button class="btn btn-success" style="width: 40%" onclick="copyUrl();">COPY URL</button>
                <button class="btn btn-primary" style="width: 40%" onclick="updateMap();">SEARCH</button>
            </div>


        </div>
    </div>
<div id="map"></div>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
        integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
        crossorigin="anonymous"></script>
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.27.0/moment.min.js"></script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.0-alpha14/js/tempusdominus-bootstrap-4.min.js"></script>

<script>
    /**
     * Handle the select system of the search form,
     * every time that a select change,
     * set in other select new possible values.
     */
    function populateForm(e) {
        for (let id of id_select_list) {
            if (e && e.id === id) {
                selected_values[id] = document.getElementById(id).selectedOptions[0].value;
            } else {
                let index_list = [...Array(select_values_lists[id].length).keys()];
                for (let id2 of id_select_list) {
                    if (id !== id2) {
                        let target = document.getElementById(id2).selectedOptions[0].value;
                        if (target !== "*") {
                            let temp_index_list = [];
                            for (let i of index_list) {
                                if (select_values_lists[id2][i] === target) {
                                    temp_index_list.push(i);
                                }
                            }
                            index_list = temp_index_list;
                        }
                    }
                }
                let values = [];
                for (let i of index_list) {
                    values.push(select_values_lists[id][i]);
                }
                populateSelect(id, values);
            }
        }

        // update only calendar filed
        populateDate();
        //select hour and dsn
        let select = document.getElementById("hour");
        select.value = selected_values["hour"];
        select = document.getElementById("dsn");
        select.value = selected_values["dsn"];
    }

    /**
     * Equal to populateForm but only used for hour, hour not impact on other var
     */
    function populateHour(e) {
        if (e && e.id === "hour") {
            selected_values["hour"] = document.getElementById("hour").selectedOptions[0].value;
        }
    }

    /**
     * populate calendar field and on change use hide filed  data  to get possible value
     */
    function populateDate() {

        let select = document.getElementById("date");
        let options = [];
        for (let i = 0, len = select.options.length; i < len; i++) {
            if (select.options[i].value !== "*") {
                options.push(select.options[i].value);
            }
        }

        $('#datetimepicker').datetimepicker({
            format: 'L',
            defaultDate: selected_values.date, //selected_values.date,
            enabledDates: options
        });

        $('#datetimepicker').on('change.datetimepicker datetimepicker.change', function (e) {
            // set on hidden field the selected date  and call function that update all filed using onchenge vent
            let selected_date = e.date.toDate();
            selected_date = selected_date.getFullYear() + "-" +
                ((selected_date.getMonth() + 1 < 10) ? '0' + (selected_date.getMonth() + 1) : '' + (selected_date.getMonth() + 1)) + "-" +
                ((selected_date.getDate() < 10) ? '0' + (selected_date.getDate()) : '' + (selected_date.getDate()))
            let select = document.getElementById("date");
            let opt = document.createElement('option');
            opt.value = selected_date;
            opt.innerHTML = selected_date;
            opt.selected = true;
            select.appendChild(opt);

            select.dispatchEvent(new Event('change'));
        });

    }

    /**
     * Equal to populateForm but only used for dsn, dsn not impact on other var
     */
    function populateDSN(e) {
        if (e && e.id === "dsn") {
            selected_values["dsn"] = document.getElementById("dsn").selectedOptions[0].value;
        }
    }


    /**
     *
     * @param id select id
     * @param values options to add to the select
     * Add to the select distinct value and select again the option selected
     * selected_values is a global variable!
     */
    function populateSelect(id, values) {
        //do a distinct operation
        let unique = [...new Set(values)];
        var select = document.getElementById(id);
        //clear select option
        for (i = select.options.length - 1; i >= 0; i--) {
            select.options[i] = null;
        }
        //create  wildcard option
        let opt = document.createElement('option');
        opt.value = "*";
        opt.innerHTML = "*";
        if (selected_values[id] === "*") {
            opt.selected = true;
        }
        select.appendChild(opt);

        //append distinct option to select
        for (var i = 0; i < unique.length; i++) {
            let opt = document.createElement('option');
            opt.value = unique[i];
            let unique_html = unique[i];
            //Use borinud config file to translate code in verbose text
            if (id === "vars") {
                if (borinud.config.B[unique_html] !== undefined) {
                    unique_html = borinud.config.B[unique_html].description + " " + borinud.config.B[unique_html].unit;
                }
            } else if (id === "level") {
                let [l1, l2, l3, l4] = borinud.config.level.decode(unique_html);
                unique_html = borinud.config.level.describe(l1, l2, l3, l4);
            } else if (id === "timerange") {
                let [t1, t2, t3, t4] = borinud.config.trange.decode(unique_html);
                unique_html = borinud.config.trange.describe(t1, t2, t3, t4);
            }
            opt.innerHTML = unique_html;


            if (selected_values[id] === unique[i]) {
                opt.selected = true;
            }
            select.appendChild(opt);
        }

    }

    /**
     * Copy to clipboard the new url to repeat query with same params
     */
    function copyUrl() {
        //create the new url
        let newUrl = `${url_vars[0]}//${url_vars[2]}/${url_vars[3]}/${selected_values.ident}/${selected_values.lon_lat}/` +
            `${selected_values.network}/${selected_values.timerange}/${selected_values.level}/${selected_values.vars}/` +
            `${url_vars[10]}/${selected_values.date.split("-")[0]}/${selected_values.date.split("-")[1]}/${selected_values.date.split("-")[2]}` +
            `${selected_values.hour !== "*" ? "/" + selected_values.hour : ""}?dsn=${selected_values.dsn}`;
        /* Get the text field */
        let copyText = document.getElementById("newUrlClipboard");
        copyText.style.display = 'block';
        copyText.value = newUrl;

        /* Select the text field */
        copyText.select();

        /* Copy the text inside the text field */
        document.execCommand("copy");
        copyText.style.display = 'none';
        alert("New url copy to clipboard.")
    }

    var map = L.map('map').setView([43, 11], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // global config for borinud request
    var borinud = {
        config: {
            root_el: null,
            ajax: {
                baseUrl: "/borinud/api/v1/jsonline",
                dataType: "text"
            },
        }
    };
    // list of identifiers for select, selected_values and corresponding summaries
    var id_select_list = ["ident", "lon_lat", "network", "date", "vars", "timerange", "level"];
    // list of possibible value for each summaries,
    var select_values_lists = {
        ident: [],
        lon_lat: [],
        network: [],
        date: [],
        hour: ["*", "00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15",
            "16", "17", "18", "19", "20", "21", "22", "23"],
        vars: [],
        timerange: [],
        level: [],
        dsn: ["report", "sample"]
    };


    /**
     * required combination of all summaries and put these in select_values_lists
     *
     */
    $.ajax({
        url: borinud.config.ajax.baseUrl + "/*/*/*/*/*/*/summaries",
        dataType: borinud.config.ajax.dataType,
        success: function (resp) {
            resp = (JSON.parse("{\"j\":[" + resp.replace(/}\n{/g, "}, {") + "]}")).j;

            for (var r of resp) {
                select_values_lists.ident.push(r.ident + "");
                select_values_lists.lon_lat.push(r.lon + "," + r.lat);
                select_values_lists.network.push(r.network + "");
                select_values_lists.date.push((r.date[0] + "").substring(0, 10));
                let d = r.data[0];
                select_values_lists.vars.push(Object.keys(d.vars)[0] + "");
                select_values_lists.timerange.push(d.timerange + "");
                select_values_lists.level.push(d.level + "");
            }
            populateForm(undefined);
        },

        error: function (e) {
            console.log(e.toString());
        }
    });
</script>

</body>
</html>